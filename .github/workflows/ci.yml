name: Strojenie i walidacja regulatorÃ³w

on:
  workflow_dispatch:
    inputs:
      regulator:
        description: 'Wybierz regulator do przetestowania'
        required: true
        default: 'regulator_pid'
        type: choice
        options:
          - regulator_pid
          - regulator_pi
          - regulator_dwupolozeniowy

jobs:
  tune:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Strojenie regulatorÃ³w
        run: |
          docker run --rm \
            -e REGULATOR=${{ github.event.inputs.regulator }} \
            -e TRYB=strojenie \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test

      - name: Upload tuning results
        uses: actions/upload-artifact@v4
        with:
          name: wyniki-tune
          path: wyniki/

  validate_zbiornik:
    runs-on: ubuntu-latest
    needs: tune
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Download tuning results
        uses: actions/download-artifact@v4
        with:
          name: wyniki-tune
          path: wyniki/

      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Walidacja modelu zbiornik_1rz
        run: |
          docker run --rm \
            -e REGULATOR=${{ github.event.inputs.regulator }} \
            -e TRYB=walidacja \
            -e MODEL=zbiornik_1rz \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test || echo "FAIL" > result.txt

      - name: Upload partial results
        uses: actions/upload-artifact@v4
        with:
          name: wyniki-zbiornik
          path: wyniki/

  validate_dwa_zbiorniki:
    runs-on: ubuntu-latest
    needs: tune
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Download tuning results
        uses: actions/download-artifact@v4
        with:
          name: wyniki-tune
          path: wyniki/

      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Walidacja modelu dwa_zbiorniki
        run: |
          docker run --rm \
            -e REGULATOR=${{ github.event.inputs.regulator }} \
            -e TRYB=walidacja \
            -e MODEL=dwa_zbiorniki \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test || echo "FAIL" > result.txt

      - name: Upload partial results
        uses: actions/upload-artifact@v4
        with:
          name: wyniki-dwa
          path: wyniki/

  validate_wahadlo:
    runs-on: ubuntu-latest
    needs: tune
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Download tuning results
        uses: actions/download-artifact@v4
        with:
          name: wyniki-tune
          path: wyniki/

      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Walidacja modelu wahadlo_odwrocone
        run: |
          docker run --rm \
            -e REGULATOR=${{ github.event.inputs.regulator }} \
            -e TRYB=walidacja \
            -e MODEL=wahadlo_odwrocone \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test || echo "FAIL" > result.txt

      - name: Upload partial results
        uses: actions/upload-artifact@v4
        with:
          name: wyniki-wahadlo
          path: wyniki/

  summary:
    runs-on: ubuntu-latest
    needs: [validate_zbiornik, validate_dwa_zbiorniki, validate_wahadlo]
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Download all validation results
        uses: actions/download-artifact@v4
        with:
          pattern: wyniki-*
          merge-multiple: true
          path: wyniki/

      - name: Move all reports to main wyniki folder
        run: |
          echo "ðŸ“¦ KopiujÄ™ wyniki z podkatalogÃ³w..."
          find wyniki -type f -name "*.json" -exec mv {} wyniki/ \; || true
          find wyniki -type f -name "*.png" -exec mv {} wyniki/ \; || true
          ls -R wyniki

      - name: Generuj raport zbiorczy
        run: |
          docker run --rm \
            -e REGULATOR=${{ github.event.inputs.regulator }} \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test python src/ocena_metod.py || echo "âš ï¸ Brak raportÃ³w do oceny w katalogu: wyniki"

      - name: SprawdÅº wyniki i zdecyduj o statusie
        run: |
          cd wyniki
          if [ ! -f raport.html ]; then
            echo "âš ï¸ Brak raportu HTML â€” prawdopodobnie brak wynikÃ³w walidacji"
            exit 1
          fi

          PASS_COUNT=$(grep -o "âœ…" raport.html | wc -l)
          if [ "$PASS_COUNT" -eq 0 ]; then
            echo "âŒ Å»aden model nie speÅ‚niÅ‚ progÃ³w jakoÅ›ci â€” pipeline FAIL"
            exit 1
          else
            echo "âœ… Walidacja pozytywna â€” pipeline OK ($PASS_COUNT pozytywnych testÃ³w)"
          fi

      - name: Upload raportu koÅ„cowego
        uses: actions/upload-artifact@v4
        with:
          name: raport_${{ github.event.inputs.regulator }}
          path: wyniki/

  deploy:
    runs-on: ubuntu-latest
    needs: summary
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: Download validation summary
        uses: actions/download-artifact@v4
        with:
          name: raport_${{ github.event.inputs.regulator }}
          path: wyniki/

      - name: Read passed models
        id: read_models
        run: |
          if [ ! -f wyniki/passed_models.txt ]; then
            echo "âš ï¸ Brak modeli do wdroÅ¼enia."
            echo "models=" >> $GITHUB_OUTPUT
          else
            echo "âœ… Modele do wdroÅ¼enia:"
            cat wyniki/passed_models.txt
            echo "models=$(cat wyniki/passed_models.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push images for passed models
        if: ${{ steps.read_models.outputs.models != '' }}
        run: |
          for MODEL in ${{ steps.read_models.outputs.models }}; do
            IMAGE="ghcr.io/${{ github.repository_owner }}/${MODEL}-regulator:latest"
            echo "ðŸš€ BudujÄ™ i wysyÅ‚am obraz: $IMAGE"
            docker build -t $IMAGE -f kontener/Dockerfile .
            docker push $IMAGE
          done

      - name: Update GitOps repository
        if: ${{ steps.read_models.outputs.models != '' }}
        env:
          GITOPS_REPO: "https://github.com/JakubZasadni/cl-gitops-regulatory.git"
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git clone $GITOPS_REPO gitops
          cd gitops
          for MODEL in ${{ steps.read_models.outputs.models }}; do
            echo "ðŸ”§ AktualizujÄ™ manifest dla modelu: $MODEL"
            yq -i ".spec.template.spec.containers[0].image = \"ghcr.io/${{ github.repository_owner }}/${MODEL}-regulator:latest\"" kustomize/apps/${MODEL}/base/deployment.yml
          done
          git config user.email "ci@github"
          git config user.name "GitHub Actions"
          git commit -am "auto-deploy: updated images for passed models"
          git push
