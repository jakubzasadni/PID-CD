name: Strojenie i walidacja regulator贸w

on:
  workflow_dispatch:
    inputs:
      regulator:
        description: 'Wybierz regulator do przetestowania'
        required: true
        default: 'regulator_pid'
        type: choice
        options:
          - all
          - regulator_p
          - regulator_pi
          - regulator_pd
          - regulator_pid

jobs:
  # -----------------------------------------------------
  # 1锔 Strojenie regulator贸w
  # -----------------------------------------------------
  tune:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Strojenie regulator贸w (tylko etap strojenia)
        run: |
          if [ "${{ github.event.inputs.regulator }}" = "all" ]; then
            for REG in regulator_p regulator_pi regulator_pd regulator_pid; do
              echo "[STROJENIE] Regulator: $REG"
              docker run --rm \
                -e REGULATOR=$REG \
                -e TRYB=strojenie \
                -v ${{ github.workspace }}/wyniki:/app/wyniki \
                regulator-sim:test python src/uruchom_symulacje.py
            done
          else
            docker run --rm \
              -e REGULATOR=${{ github.event.inputs.regulator }} \
              -e TRYB=strojenie \
              -v ${{ github.workspace }}/wyniki:/app/wyniki \
              regulator-sim:test python src/uruchom_symulacje.py
          fi

      - name: Upload tuning results
        uses: actions/upload-artifact@v4
        with:
          name: wyniki-tune
          path: |
            wyniki/parametry_*.json
            wyniki/raport_strojenie_*.html
            wyniki/strojenie_*.png

  # -----------------------------------------------------
  # 2锔 Walidacja modeli (ka偶dy w osobnym kroku)
  # -----------------------------------------------------
  validate_zbiornik:
    runs-on: ubuntu-latest
    needs: tune
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Download tuning results
        uses: actions/download-artifact@v4
        with:
          name: wyniki-tune
          path: wyniki/
      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .
      - name: Walidacja modelu zbiornik_1rz
        run: |
          if [ "${{ github.event.inputs.regulator }}" = "all" ]; then
            for REG in regulator_p regulator_pi regulator_pd regulator_pid; do
              echo "[WALIDACJA] $REG na modelu zbiornik_1rz"
              docker run --rm \
                -e REGULATOR=$REG \
                -e TRYB=walidacja \
                -e MODEL=zbiornik_1rz \
                -v ${{ github.workspace }}/wyniki:/app/wyniki \
                regulator-sim:test python src/uruchom_symulacje.py || echo "FAIL" > result.txt
            done
          else
            docker run --rm \
              -e REGULATOR=${{ github.event.inputs.regulator }} \
              -e TRYB=walidacja \
              -e MODEL=zbiornik_1rz \
              -v ${{ github.workspace }}/wyniki:/app/wyniki \
              regulator-sim:test python src/uruchom_symulacje.py || echo "FAIL" > result.txt
          fi
      - name: Upload partial results
        uses: actions/upload-artifact@v4
        with:
          name: wyniki-zbiornik
          path: wyniki/

  validate_dwa_zbiorniki:
    runs-on: ubuntu-latest
    needs: tune
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Download tuning results
        uses: actions/download-artifact@v4
        with:
          name: wyniki-tune
          path: wyniki/
      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .
      - name: Walidacja modelu dwa_zbiorniki
        run: |
          if [ "${{ github.event.inputs.regulator }}" = "all" ]; then
            for REG in regulator_p regulator_pi regulator_pd regulator_pid; do
              echo "[WALIDACJA] $REG na modelu dwa_zbiorniki"
              docker run --rm \
                -e REGULATOR=$REG \
                -e TRYB=walidacja \
                -e MODEL=dwa_zbiorniki \
                -v ${{ github.workspace }}/wyniki:/app/wyniki \
                regulator-sim:test python src/uruchom_symulacje.py || echo "FAIL" > result.txt
            done
          else
            docker run --rm \
              -e REGULATOR=${{ github.event.inputs.regulator }} \
              -e TRYB=walidacja \
              -e MODEL=dwa_zbiorniki \
              -v ${{ github.workspace }}/wyniki:/app/wyniki \
              regulator-sim:test python src/uruchom_symulacje.py || echo "FAIL" > result.txt
          fi
      - name: Upload partial results
        uses: actions/upload-artifact@v4
        with:
          name: wyniki-dwa-zbiorniki
          path: wyniki/

  validate_wahadlo:
    runs-on: ubuntu-latest
    needs: tune
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Download tuning results
        uses: actions/download-artifact@v4
        with:
          name: wyniki-tune
          path: wyniki/
      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .
      - name: Walidacja modelu wahadlo_odwrocone
        run: |
          if [ "${{ github.event.inputs.regulator }}" = "all" ]; then
            for REG in regulator_p regulator_pi regulator_pd regulator_pid; do
              echo "[WALIDACJA] $REG na modelu wahadlo_odwrocone"
              docker run --rm \
                -e REGULATOR=$REG \
                -e TRYB=walidacja \
                -e MODEL=wahadlo_odwrocone \
                -e DT=0.005 \
                -v ${{ github.workspace }}/wyniki:/app/wyniki \
                regulator-sim:test python src/uruchom_symulacje.py || echo "FAIL" > result.txt
            done
          else
            docker run --rm \
              -e REGULATOR=${{ github.event.inputs.regulator }} \
              -e TRYB=walidacja \
              -e MODEL=wahadlo_odwrocone \
              -e DT=0.005 \
              -v ${{ github.workspace }}/wyniki:/app/wyniki \
              regulator-sim:test python src/uruchom_symulacje.py || echo "FAIL" > result.txt
          fi
      - name: Upload partial results
        uses: actions/upload-artifact@v4
        with:
          name: wyniki-wahadlo
          path: wyniki/

  # -----------------------------------------------------
  # 3锔 Podsumowanie i generacja raportu
  # -----------------------------------------------------
  summary:
    runs-on: ubuntu-latest
    needs: [validate_zbiornik, validate_dwa_zbiorniki, validate_wahadlo]
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Download all validation results
        uses: actions/download-artifact@v4
        with:
          pattern: wyniki-*
          merge-multiple: true
          path: wyniki/

      - name: Move all reports to main wyniki folder
        run: |
          echo "Kopiuj wyniki z podkatalog贸w..."
          find wyniki -type f -name "*.json" -exec mv {} wyniki/ \; || true
          find wyniki -type f -name "*.png" -exec mv {} wyniki/ \; || true
          ls -R wyniki

      - name: Generuj raport zbiorczy
        run: |
          docker run --rm \
            -e REGULATOR=${{ github.event.inputs.regulator }} \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test python src/ocena_metod.py || echo "[UWAGA] Brak raportow do oceny w katalogu: wyniki"

      - name: Generuj raport kocowy por贸wnawczy (NEW v2.1)
        run: |
          echo "[ANALIZA] Generowanie raportu kocowego..."
          docker run --rm \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test python src/raport_koncowy.py --wyniki-dir /app/wyniki || echo "[UWAGA] Bd przy generowaniu raportu kocowego"

      - name: Generuj metryki CI/CD (NEW v2.1)
        run: |
          echo "[METRYKI] Generowanie metryk pipeline..."
          docker run --rm \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test python -c "from src.metryki_pipeline import MetrykiPipeline; m = MetrykiPipeline('/app/wyniki'); m.generuj_badge_svg(); m.generuj_raport_markdown()" || echo "[UWAGA] Bd przy generowaniu metryk"

      - name: Sprawd藕 wyniki i zdecyduj o statusie
        run: |
          cd wyniki
          if [ ! -f raport.html ]; then
            echo "Brak raportu HTML - prawdopodobnie brak wynikow walidacji"
            exit 1
          fi

          PASS_COUNT=$(grep -o "\[OK\]" raport.html | wc -l)
          if [ "$PASS_COUNT" -eq 0 ]; then
            echo "[X] Zaden model nie spelni progow jakoci - pipeline FAIL"
            exit 1
          else
            echo "[OK] Walidacja pozytywna - pipeline OK ($PASS_COUNT pozytywnych testow)"
          fi

      - name: Upload raportu kocowego
        uses: actions/upload-artifact@v4
        with:
          name: raport_${{ github.event.inputs.regulator }}
          path: wyniki/

  # -----------------------------------------------------
  # 4锔 Wdro偶enie regulator贸w (GitOps)
  # -----------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: summary
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: Download validation summary
        uses: actions/download-artifact@v4
        with:
          name: raport_${{ github.event.inputs.regulator }}
          path: wyniki/

      - name: Read passed models
        id: read_models
        run: |
          echo "[PLIKI] Odczytuje liste modeli..."
          if [ ! -f wyniki/passed_models.txt ]; then
            echo "[UWAGA] Brak pliku wyniki/passed_models.txt"
            echo "has_models=false" >> $GITHUB_OUTPUT
          else
            echo "[OK] Modele do wdrozenia:"
            cat wyniki/passed_models.txt
            MODELS=$(cat wyniki/passed_models.txt | tr '\n' ' ' | xargs)
            echo "models=$MODELS" >> $GITHUB_OUTPUT
            echo "has_models=true" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        if: steps.read_models.outputs.has_models == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push images for passed models
        if: steps.read_models.outputs.has_models == 'true'
        run: |
          for MODEL in ${{ steps.read_models.outputs.models }}; do
            SAFE_MODEL=$(echo "$MODEL" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
            OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            IMAGE="ghcr.io/${OWNER}/${SAFE_MODEL}-regulator:latest"
            echo "[BUILD] Buduje i wysylam obraz: $IMAGE"
            docker build -t "$IMAGE" -f kontener/Dockerfile .
            docker push "$IMAGE"
          done

      - name: Update GitOps repository (automated v2.1)
        if: steps.read_models.outputs.has_models == 'true'
        env:
          GITOPS_REPO: "https://github.com/JakubZasadni/cl-gitops-regulatory.git"
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          set -e
          echo "З Klonuj repozytorium GitOps..."
          git clone https://${GH_TOKEN}@github.com/JakubZasadni/cl-gitops-regulatory.git gitops
          
          echo "[START] Automatyczne wdrozenie przez nowy skrypt..."
          docker run --rm \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            -v ${{ github.workspace }}/gitops:/app/gitops \
            regulator-sim:test python src/wdrozenie_gitops.py \
              --wyniki-dir /app/wyniki \
              --gitops-repo /app/gitops \
              --push || echo "[UWAGA] Wdrozenie GitOps zakonczone z ostrzezeniami"
          
          cd gitops
          git config user.email "ci@github"
          git config user.name "GitHub Actions"

          echo "[INFO] Sprawdzam zmiany w GitOps..."
          if git diff --quiet; then
            echo "[OK] Brak zmian do zapisania - pomijam push."
          else
            echo "[PUSH] Wypycham zmiany GitOps..."
            git push origin main || (echo '[X] Git push failed, sprawdz uprawnienia GH_TOKEN' && exit 1)
          fi
          
          echo "[DOCKER] Aktualizuje tagi obrazow Docker..."
          cd ..
          for MODEL in ${{ steps.read_models.outputs.models }}; do
            SAFE_MODEL=$(echo "$MODEL" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
            echo "[KONFIGURACJA] Aktualizuje obraz dla modelu: $SAFE_MODEL"
            yq -i ".spec.template.spec.containers[0].image = \"ghcr.io/${{ github.repository_owner }}/${SAFE_MODEL}-regulator:latest\"" gitops/kustomize/apps/${SAFE_MODEL}/base/deployment.yml || echo "[UWAGA] Brak pliku deployment.yml dla $SAFE_MODEL"
          done
          
          cd gitops
          if git diff --quiet; then
            echo "[OK] Obrazy juz aktualne"
          else
            git add .
            git commit -m "auto-deploy: updated Docker images for passed models [ci skip]"
            git push origin main
          fi
