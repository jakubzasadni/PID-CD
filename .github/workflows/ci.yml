name: Strojenie i walidacja regulatorÃ³w (Pipeline v2.1)

on:
  workflow_dispatch:
    inputs:
      regulator:
        description: 'Wybierz regulator do przetestowania'
        required: true
        default: 'regulator_pid'
        type: choice
        options:
          - all
          - regulator_p
          - regulator_pi
          - regulator_pd
          - regulator_pid

jobs:
  # ============================================================================
  # ğŸš€ Pipeline kompletny (4 etapy)
  # ============================================================================
  pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Run pipeline for selected regulator(s)
        run: |
          if [ "${{ github.event.inputs.regulator }}" = "all" ]; then
            echo "ğŸ”„ Uruchamiam pipeline dla wszystkich regulatorÃ³w..."
            for REG in regulator_p regulator_pi regulator_pd regulator_pid; do
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“Š Pipeline dla: $REG"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              docker run --rm \
                -e REGULATOR=$REG \
                -v ${{ github.workspace }}/wyniki:/app/wyniki \
                regulator-sim:test python src/uruchom_pipeline.py || echo "[UWAGA] Pipeline zakoÅ„czony z bÅ‚Ä™dem dla $REG"
            done
          else
            echo "ğŸ“Š Uruchamiam pipeline dla: ${{ github.event.inputs.regulator }}"
            docker run --rm \
              -e REGULATOR=${{ github.event.inputs.regulator }} \
              -v ${{ github.workspace }}/wyniki:/app/wyniki \
              regulator-sim:test python src/uruchom_pipeline.py
          fi

      - name: Generate comprehensive final report (36 combinations)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ˆ Generowanie raportu koÅ„cowego (36 kombinacji)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          docker run --rm \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            regulator-sim:test python src/raport_koncowy.py \
              --wyniki-dir /app/wyniki \
              --output-dir /app/wyniki/raport_final || echo "[UWAGA] Raport koÅ„cowy wygenerowany z ostrzeÅ¼eniami"

      - name: Check results and determine status
        id: check_results
        run: |
          echo "ğŸ” Sprawdzam wyniki walidacji..."
          
          # SprawdÅº czy raport koÅ„cowy istnieje
          if [ ! -f wyniki/raport_final/raport_koncowy.html ]; then
            echo "âŒ Brak raportu koÅ„cowego"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # WyciÄ…gnij pass rate z raportu
          PASS_RATE=$(grep -oP 'Globalny pass rate:.*?<b>\K[0-9.]+' wyniki/raport_final/raport_koncowy.html || echo "0")
          echo "ğŸ“Š Pass rate: ${PASS_RATE}%"
          
          if (( $(echo "$PASS_RATE > 0" | bc -l) )); then
            echo "âœ… Pipeline zakoÅ„czony pomyÅ›lnie - pass rate: ${PASS_RATE}%"
            echo "status=success" >> $GITHUB_OUTPUT
            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  OstrzeÅ¼enie: 0% pass rate - sprawdÅº konfiguracjÄ™ progÃ³w"
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "pass_rate=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload comprehensive report
        uses: actions/upload-artifact@v4
        with:
          name: raport_${{ github.event.inputs.regulator }}
          path: |
            wyniki/raport_final/
            wyniki/pipeline_badge.svg
            wyniki/WYNIKI_EKSPERYMENTOW.md
            wyniki/passed_models.txt
            wyniki/najlepszy_*.json
            wyniki/parametry_*.json
          retention-days: 90

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Pipeline v2.1 zakoÅ„czony"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Pass rate: ${{ steps.check_results.outputs.pass_rate }}%"
          echo "ğŸ“ Artefakt: raport_${{ github.event.inputs.regulator }}"
          echo ""
          echo "ğŸ“ˆ Raport koÅ„cowy zawiera:"
          echo "  - raport_koncowy.html (36 kombinacji)"
          echo "  - raport_koncowy_dane.csv (wszystkie metryki)"
          echo "  - raport_koncowy_ranking.csv (ranking metod)"
          echo "  - porownanie_*.png (wykresy)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # ğŸš€ GitOps Deployment (opcjonalny - tylko gdy pipeline sukces)
  # ============================================================================
  deploy:
    runs-on: ubuntu-latest
    needs: pipeline
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: Download validation results
        uses: actions/download-artifact@v4
        with:
          name: raport_${{ github.event.inputs.regulator }}
          path: wyniki/

      - name: Check if deployment needed
        id: check_deploy
        run: |
          if [ -f wyniki/passed_models.txt ] && [ -s wyniki/passed_models.txt ]; then
            echo "âœ… Znaleziono modele do wdroÅ¼enia"
            MODELS=$(cat wyniki/passed_models.txt | tr '\n' ' ' | xargs)
            echo "models=$MODELS" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Brak modeli do wdroÅ¼enia (plik passed_models.txt pusty lub nie istnieje)"
            echo "deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        if: steps.check_deploy.outputs.deploy == 'true'
        run: docker build -t regulator-sim:test -f kontener/Dockerfile .

      - name: Update GitOps repository
        if: steps.check_deploy.outputs.deploy == 'true'
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          set -e
          echo "ğŸ§© KlonujÄ™ repozytorium GitOps..."
          git clone https://${GH_TOKEN}@github.com/JakubZasadni/cl-gitops-regulatory.git gitops
          
          echo "ğŸš€ Automatyczne wdroÅ¼enie przez skrypt wdrozenie_gitops.py..."
          docker run --rm \
            -v ${{ github.workspace }}/wyniki:/app/wyniki \
            -v ${{ github.workspace }}/gitops:/app/gitops \
            regulator-sim:test python src/wdrozenie_gitops.py \
              --wyniki-dir /app/wyniki \
              --gitops-repo /app/gitops \
              --push || echo "[UWAGA] WdroÅ¼enie GitOps zakoÅ„czone z ostrzeÅ¼eniami"
          
          cd gitops
          git config user.email "ci@github"
          git config user.name "GitHub Actions"

          if git diff --quiet; then
            echo "âœ… Brak zmian do zapisania"
          else
            echo "ğŸ“¤ Wypycham zmiany do GitOps..."
            git push origin main || (echo 'âŒ Git push failed' && exit 1)
          fi

      - name: Deployment summary
        if: steps.check_deploy.outputs.deploy == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… GitOps deployment zakoÅ„czony"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ WdroÅ¼one modele: ${{ steps.check_deploy.outputs.models }}"
          echo "ğŸ”— GitOps repo: https://github.com/JakubZasadni/cl-gitops-regulatory"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
